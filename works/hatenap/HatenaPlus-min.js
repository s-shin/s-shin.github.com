/* 
 * HatenaPlus.js v1.0.0
 * Copyright (C) 2011 shin <s2pch.luck@gmail.com>
 * Apache License 2.0
 * http://www.apache.org/licenses/LICENSE-2.0.html
 */
(function(){var b={replaceAll:function(g,e,f){return g.split(e).join(f)},format:function(g){for(var f=1,e=arguments.length;f<e;++f){g=this.replaceAll(g,"{"+(f-1)+"}",arguments[f])}return g},htmlspecialchars:function(f){var e=document.createElement("pre");e.textContent=f;return e.innerHTML},extend:function(g,f){if(!f||!g){return}for(var e in g){if(e in f){g[e]=f[e]}}}};var c={TOKEN:{HEAD:10,LIST:20,DEF:30,TABLE:40,PRE:50,PRE_END:51,SPRE:60,SPRE_END:61,BQ:70,BQ_END:71,NORMAL:80,BLANK:81,NOTE:90,NOTE_END:91,TAG:100,DRAFT:101,DRAFT_END:102}};var a=function(){this.initialize.apply(this,arguments)};a.prototype={initialize:function(){this.version="1.0.0";this.inline=new a.Inline();this.block=new a.Block(this.inline)},parse:function(f,e){this.inline.setup();return this.block.parse(f,e)+this.inline.getFootnote()}};a.Block=function(){this.initialize.apply(this,arguments)};a.Block.prototype={initialize:function(e){this.inline=e},tokenize:function(f){var h=[];for(var g=0;g<f.length;++g){var e=f[g];switch(e[0]){case"*":h.push(c.TOKEN.HEAD);break;case"-":if(e=="-->"){h.push(c.TOKEN.DRAFT_END)}else{h.push(c.TOKEN.LIST)}break;case"+":h.push(c.TOKEN.LIST);break;case":":if(e.lastIndexOf(":")!=0){h.push(c.TOKEN.DEF)}else{h.push(c.TOKEN.NORMAL)}break;case"|":if(e==="|<"){h.push(c.TOKEN.PRE_END)}else{if(e==="||<"){h.push(c.TOKEN.SPRE_END)}else{if(e[e.length-1]==="|"){h.push(c.TOKEN.TABLE)}else{h.push(c.TOKEN.NORMAL)}}}break;case">":if(e==">#"){h.push(c.TOKEN.NOTE)}else{if(e.search(/^>\|[^| ]*$/)!=-1){h.push(c.TOKEN.PRE)}else{if(e.search(/^>.*>$/)!=-1){h.push(c.TOKEN.BQ)}else{if(e.search(/^>\|[^| ]*\|$/)!=-1){h.push(c.TOKEN.SPRE)}else{h.push(c.TOKEN.NORMAL)}}}}break;case"<":if(e==="<<"){h.push(c.TOKEN.BQ_END)}else{if(e=="<!--"){h.push(c.TOKEN.DRAFT)}else{if(e.search(/^<.*>$/)!=-1){h.push(c.TOKEN.TAG)}else{h.push(c.TOKEN.NORMAL)}}}break;case"#":if(e=="#<"){h.push(c.TOKEN.NOTE_END)}else{h.push(c.TOKEN.NORMAL)}break;default:if(e.search(/^\s*$/)===0){h.push(c.TOKEN.BLANK)}else{h.push(c.TOKEN.NORMAL)}break}}return h},parse:function(n,f){var l={baseHeadLevel:3};b.extend(l,f);this.currentHeadLevel=0;var e=n.split(/\r?\n/);var m=this.tokenize(e);var k="";for(var h=0;h<e.length;++h){var g=this.parseOne(e,m,h,l);h=g.i;k+=g.r}for(var h=0;h<=this.currentHeadLevel-l.baseHeadLevel;++h){k+="</div></section>"}return k},parseOne:function(f,o,k,n){var l=this.syntax,e={};e[c.TOKEN.HEAD]=l.head;e[c.TOKEN.LIST]=l.list;e[c.TOKEN.DEF]=l.def;e[c.TOKEN.TABLE]=l.table;e[c.TOKEN.PRE]=l.pre;e[c.TOKEN.SPRE]=l.spre;e[c.TOKEN.BQ]=l.bq;e[c.TOKEN.NORMAL]=l.normal;e[c.TOKEN.NOTE]=l.note;e[c.TOKEN.TAG]=l.tag;e[c.TOKEN.DRAFT]=l.draft;var g={i:k,r:""};var h=o[k];if(e[h]){g=e[h].call(this,f,o,k,n);if(h!=c.TOKEN.SPRE){g.r=this.inline.parse(g.r)}}return g},syntax:{head:function(p,n,l,e){var q=p[l],f="",h=0;while(q[h]=="*"&&h<q.length){++h}var o=h-1+e.baseHeadLevel;if(o>6){o=6}for(var g=0,m=this.currentHeadLevel-o;g<=m;++g){if(g<m){f+="</div>"}f+="</section>"}this.currentHeadLevel=o;f+="<section>";f+=b.format("<h{0}>{1}</h{0}>",o,q.substring(h,q.length));f+="<div>";return{i:l,r:f}},list:function(o,n,k){var l=[];var e="";for(;k<n.length;++k){if(n[k]!=c.TOKEN.LIST){break}var g=o[k].match(/^([-+]+)(.*)$/);var f=g[1].length;var p=(g[1][f-1]=="-")?"ul":"ol";if(l.length==f){e+="</li><li>"+g[2]}else{if(l.length<f){l.push(p);e+=b.format("<{0}><li>{1}",p,g[2])}else{for(var h=0;h<l.length-f;++h){e+=b.format("</li></{0}>",l.pop())}--k;continue}}}while(l.length!=0){e+=b.format("</li></{0}>",l.pop())}--k;return{i:k,r:e}},def:function(f,k,g){var h="<dl>";for(;g<f.length;++g){if(k[g]!=c.TOKEN.DEF){break}var e=f[g].match(/^:([^:]*):(.*)$/);if(!e){break}h+=b.format("<dt>{0}</dt><dd>{1}</dd>",e[1],e[2])}h+="</dl>";--g;return{i:g,r:h}},table:function(e,k,g){var h="<table>";for(;g<k.length;++g){if(k[g]!=c.TOKEN.TABLE){break}var f=e[g].split("|");h+="<tr>";for(j=0;j<f.length;++j){if(f[j]==""){continue}if(f[j][0]=="*"){h+="<th>"+f[j].substr(1,f[j].length-1)+"</th>"}else{h+="<td>"+f[j]+"</td>"}}h+="</tr>"}h+="</table>";--g;return{i:g,r:h}},pre:function(e,l,g,k){var h="";for(++g;g<l.length;++g){if(l[g]==c.TOKEN.PRE_END){break}var f=this.parseOne(e,l,g,k);g=f.i;h+=f.r}h="<pre>"+h+"</pre>";return{i:g,r:h}},spre:function(f,l,g){var k="";var m=f[g].match(/^>\|([^|]*)\|$/)[1];var h="";for(++g;g<f.length;++g){if(l[g]==c.TOKEN.SPRE_END){break}var e=f[g];if(e=="||< "){e="||<"}h+=b.htmlspecialchars(e)+"\n"}if(m===""){k="<pre>"+h+"</pre>"}else{k="<pre><code class='language-"+m+"'>"+h+"</code></pre>"}return{i:g,r:k}},bq:function(p,n,l,e){var f="",o;var g=p[l].match(/^>(.*)>$/)[1];for(++l;l<n.length;++l){if(n[l]==c.TOKEN.BQ_END){break}o=this.parseOne(p,n,l,e);l=o.i;f+=o.r}if(g!=""){var k=g;var h=g.match(/\[(.*)(:title=.*)?\]/);if(h){g=h[1]}f=b.format("<blockquote cite='{0}'>{1}<cite>{2}</cite></blockquote>",g,f,k)}else{f="<blockquote>"+f+"</blockquote>"}return{i:l,r:f}},normal:function(e,k,f){var h="";var g=e[f];if(k[f+1]==c.TOKEN.NORMAL){for(++f;f<e.length;++f){if(k[f]!=c.TOKEN.NORMAL){break}g+="<br />"+e[f]}f--}h="<p>"+g+"</p>";return{i:f,r:h}},note:function(e,l,g,k){var h="<aside>";for(++g;g<l.length;++g){if(l[g]==c.TOKEN.NOTE_END){break}var f=this.parseOne(e,l,g,k);g=f.i;h+=f.r}h+="</aside>";return{i:g,r:h}},tag:function(e,g,f){return{i:f,r:e[f]}},draft:function(e,g,f){for(++f;f<g.length;++f){if(g[f]==c.TOKEN.DRAFT_END){break}}return{i:f,r:""}}}};a.Inline=function(){this.initialize.apply(this,arguments)};a.Inline.prototype={initialize:function(){this.id=0},setup:function(){this.notes=[];this.id++},parse:function(g){var f=g;for(var e in this.syntax){f=this.syntax[e].call(this,f)}return f},syntax:{address:function(n){var h=n;var e=n.match(/\[[^\[\]]*\]/g);if(!e){return h}for(var g=0;g<e.length;++g){var l=e[g].match(/^\[(https?:\/\/|ftp:\/\/|mailto:|url:)([-_.!~*'()a-zA-Z0-9;\/?\@&=+\$,%#]+):title=(.*)?\]$/);if(!l){l=e[g].match(/^\[(https?:\/\/|ftp:\/\/|mailto:)([-_.!~*'()a-zA-Z0-9;\/?:\@&=+\$,%#]+)\]$/);if(!l){continue}}var f="";if(l[1]!="url:"){f+=l[1]}f+=l[2];var k="";if(l.length>3&&l[3]){k=l[3]}if(!k){if(l[1]!="mailto:"&&l[1]!="url:"){k=l[1]+l[2]}else{k=l[2]}}h=h.replace(e[g],b.format("<a href='{0}'>{1}</a>",f,k))}return h},code:function(k){var e=k.match(/``([^`]`|[^`])*`\w*`/g);if(!e){return k}var g=k;for(var f=0;f<e.length;++f){var h=e[f].match(/^``(.*)`(\w*)`$/);g=g.replace(e[f],b.format("<code{0}>{1}</code>",h[2]?" class='language-"+h[2]+"'":"",b.htmlspecialchars(h[1])))}return g},footnote:function(k){var g=k;var e=k.match(/\(\(([^)]\)|[^)])*\)\)/g);if(!e){return g}for(var f=0;f<e.length;++f){var h=e[f].match(/^\(\((.*)\)\)$/);g=g.replace(e[f],b.format("<span class='footnote'><a name='fn{0}-{1}' href='#f{0}-{1}' title='{2}'>*{1}</a></span>",this.id,this.notes.length+1,h[1]));this.notes.push(h[1])}return g}},getFootnote:function(){var f=this.notes;if(f.length==0){return""}var g="<div class='footnote'>";for(var e=0;e<f.length;++e){g+="<p class='footnote'>";g+=b.format("<a name='f{0}-{1}' href='#fn{0}-{1}'>*{1}</a>ï¼š",this.id,e+1);g+=f[e];g+="</p>"}g+="</div>";return g}};var d=new a();window.HatenaPlus=function(f,e){return d.parse(f,e)}}());